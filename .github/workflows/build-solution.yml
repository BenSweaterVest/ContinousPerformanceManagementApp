name: Build Dataverse Solution

on:
  push:
    branches:
      - main
      - 'claude/**'
    paths:
      - 'solution/**'
      - 'deployment/**'
      - '.github/workflows/build-solution.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'solution/**'
      - 'deployment/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    name: Build Solution Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get solution version
        id: get_version
        run: |
          VERSION=$(grep -oP '<Version>\K[0-9.]+' solution/Other/Solution.xml)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Solution version: $VERSION"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-utils

      - name: Install Power Platform CLI
        run: |
          set -euo pipefail

          PAC_VERSION="1.50.1"
          INSTALL_DIR="$HOME/.local/bin"
          mkdir -p "$INSTALL_DIR"

          # Download official pac tarball from GitHub releases (fallback to dotnet if download fails)
          TAR_URL="https://github.com/microsoft/PowerApps-Cli/releases/download/v${PAC_VERSION}/pac-x64.tar.gz"

          echo "Attempting to download pac from ${TAR_URL}..."
          if curl -fsSL -o /tmp/pac.tar.gz "${TAR_URL}"; then
            tar -xzf /tmp/pac.tar.gz -C "$INSTALL_DIR"
            chmod +x "$INSTALL_DIR/pac" || true
            echo "$INSTALL_DIR" >> $GITHUB_PATH
            echo "âœ… pac installed to $INSTALL_DIR"
          else
            echo "Download failed; falling back to dotnet tool install"
            # Fallback: try dotnet tool install with retries
            wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh
            chmod +x dotnet-install.sh
            ./dotnet-install.sh --channel 8.0 --install-dir ~/.dotnet
            export PATH="$HOME/.dotnet:$PATH"
            dotnet nuget locals all --clear

            for i in 1 2 3; do
              if dotnet tool install microsoft.powerapps.cli.tool --tool-path $HOME/.dotnet/tools --version $PAC_VERSION; then
                echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
                break
              fi
              echo "Retrying dotnet tool install ($i/3)..."
              sleep 5
            done
          fi

          # Verify
          if command -v pac >/dev/null 2>&1; then
            pac --version
          else
            echo "âŒ ERROR: pac not found in PATH after install"
            exit 1
          fi

      - name: Validate Customizations.xml structure
        run: |
          echo "Validating Customizations.xml..."

          # Check file exists
          if [ ! -f "solution/Other/Customizations.xml" ]; then
            echo "âŒ ERROR: Customizations.xml not found!"
            exit 1
          fi

          # Check file size (should be ~500KB if fixed)
          SIZE=$(stat -f%z "solution/Other/Customizations.xml" 2>/dev/null || stat -c%s "solution/Other/Customizations.xml")
          SIZE_KB=$((SIZE / 1024))
          echo "File size: ${SIZE_KB} KB"

          if [ $SIZE_KB -lt 450 ]; then
            echo "âš ï¸  WARNING: File seems small (expected ~500KB)"
            echo "This might indicate fixes haven't been applied."
          fi

          # Validate XML structure
          xmllint --noout solution/Other/Customizations.xml 2>&1 || {
            echo "âŒ ERROR: Customizations.xml is not well-formed XML!"
            exit 1
          }

          echo "âœ… XML validation passed"

      - name: Validate Solution.xml
        run: |
          echo "Validating Solution.xml..."
          xmllint --noout solution/Other/Solution.xml || {
            echo "âŒ ERROR: Solution.xml is not well-formed XML!"
            exit 1
          }
          echo "âœ… XML validation passed"

      - name: Create solution package with pac CLI
        run: |
          echo "Creating solution package with pac solution pack..."

          VERSION="${{ steps.get_version.outputs.version }}"
          ZIP_NAME="PerformanceManagement_${VERSION//./_}.zip"

          # Ensure pac is in PATH
          export PATH="$HOME/.dotnet/tools:$PATH"

          # Pack the solution using pac CLI
          pac solution pack \
            --zipfile "${ZIP_NAME}" \
            --folder "./solution" \
            --packagetype Unmanaged \
            --errorlevel Verbose

          if [ -f "${ZIP_NAME}" ]; then
            SIZE=$(stat -f%z "${ZIP_NAME}" 2>/dev/null || stat -c%s "${ZIP_NAME}")
            SIZE_KB=$((SIZE / 1024))
            echo "âœ… Package created: ${ZIP_NAME} (${SIZE_KB} KB)"

            # Save for artifacts
            echo "zip_name=${ZIP_NAME}" >> $GITHUB_ENV
            echo "zip_size=${SIZE_KB}" >> $GITHUB_ENV
          else
            echo "âŒ ERROR: Failed to create package!"
            exit 1
          fi

      - name: Verify package contents
        run: |
          echo "Verifying package contents..."
          ZIP_NAME="${{ env.zip_name }}"

          # List contents
          echo "Package contents:"
          unzip -l "${ZIP_NAME}"

          # Verify required files (packed format has lowercase names at root)
          REQUIRED_FILES=(
            "solution.xml"
            "customizations.xml"
            "[Content_Types].xml"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if unzip -l "${ZIP_NAME}" | grep -q "${file}"; then
              echo "  âœ… ${file}"
            else
              echo "  âŒ ${file} MISSING!"
              exit 1
            fi
          done

          echo "âœ… All required files present"

      - name: Generate build summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # ðŸ“¦ Solution Build Summary

          ## Package Information

          | Property | Value |
          |----------|-------|
          | **Version** | ${{ steps.get_version.outputs.version }} |
          | **Package Name** | ${{ env.zip_name }} |
          | **Package Size** | ${{ env.zip_size }} KB |
          | **Build Status** | âœ… Success |

          ## Validation Results

          - âœ… Customizations.xml - Well-formed XML
          - âœ… Solution.xml - Well-formed XML
          - âœ… Package created successfully
          - âœ… All required files present

          ## Next Steps

          1. Download the package artifact from this workflow run
          2. Import into Teams Dataverse:
             - Teams â†’ Power Apps â†’ Build tab
             - Select your team
             - Import â†’ Upload ZIP

          ## Quick Stats

          - **Entities**: 9 custom tables
          - **Expected Import Time**: 5-15 minutes
          - **Ready for Production**: Yes
          EOF

      - name: Upload solution package
        uses: actions/upload-artifact@v4
        with:
          name: PerformanceManagement-v${{ steps.get_version.outputs.version }}
          path: ${{ env.zip_name }}
          retention-days: 90
          if-no-files-found: error

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        with:
          name: validation-report-${{ github.run_number }}
          path: |
            solution/Other/Solution.xml
            solution/Other/Customizations.xml
          retention-days: 30
